var airpub=angular.module("airpub",["ui.bootstrap","ui.router","duoshuo","upyun"]);airpub.config(function($stateProvider,$urlRouterProvider){$urlRouterProvider.otherwise("/404");$stateProvider.state("home",{url:"",templateUrl:"views/archive.html",controller:"archive"}).state("index",{url:"/",templateUrl:"views/archive.html",controller:"archive"}).state("single",{url:"/article/:uri",templateUrl:"views/single.html",controller:"single"}).state("404",{url:"/404",templateUrl:"views/404.html"}).state("create",{url:"/create",templateUrl:"views/admin.html",controller:"admin"}).state("update",{url:"/article/:uri/update",templateUrl:"views/admin.html",controller:"admin"})});airpub.directive("editor",function($upyun,$timeout){return{restrict:"A",require:"ngModel",link:function(scope,iElement,iAttrs,ctrl){var $=angular.element;$(iElement).addClass("editor");if(!window.Editor)return false;window.editor=new Editor({toolbar:[{name:"bold",action:Editor.toggleBold},{name:"italic",action:Editor.toggleItalic},"|",{name:"quote",action:Editor.toggleBlockquote},{name:"unordered-list",action:Editor.toggleUnOrderedList},{name:"ordered-list",action:Editor.toggleOrderedList},"|",{name:"link",action:Editor.drawLink},{name:"image",action:Editor.drawImage},{name:"upload",action:uploadAndDrawImage},{name:"fullscreen",action:Editor.toggleFullScreen}]});editor.render();editor.codemirror.on("change",onChange);$upyun.set("bucket","upyun-form");$upyun.set("form_api_secret","IRoTyNc75husfQD24cq0bNmRSDI=");ctrl.$render=function(){if(!editor)return;editor.codemirror.setValue(ctrl.$isEmpty(ctrl.$viewValue)?"":ctrl.$viewValue)};function onChange(){ctrl.$setViewValue(editor.codemirror.getValue())}function uploadAndDrawImage(){var uploading=false;var cm=editor.codemirror;var stat=editor.getState(cm);if(!$upyun){return editor._replaceSelection(cm,stat.image,"![","](http://)")}if(!document.getElementById("fileUpload")){var hiddenInputFile=document.createElement("input");hiddenInputFile.id="fileUpload";hiddenInputFile.type="file";hiddenInputFile.name="file";hiddenInputFile.style.display="none";$(iElement).after(hiddenInputFile)}var inputButton=document.getElementById("fileUpload");inputButton.click();$(inputButton).on("change",function(eve){if(uploading)return;uploading=true;$upyun.upload(iAttrs.formName,function(err,response,image){uploading=false;if(err)return console.error(err);var uploadOk=image.code===200&&image.message==="ok";if(!uploadOk)return;editor._replaceSelection(cm,stat.image,"![","]("+image.absUrl+")")})})}}}});airpub.filter("marked",function($sce){return function(raw){if(!raw)return"";if(!marked)throw new Error("marked.js required!");var markedOptions={};if(hljs)markedOptions.highlight=highlightCode;var render=new marked.Renderer;render.code=function(code,lang,escaped){if(this.options.highlight){var out=this.options.highlight(code,lang);if(out!=null&&out!==code){escaped=true;code=out}}return wrapwith("code-section",'<pre><code class="'+lang+'">'+code+"</code></pre>")};render.html=function(html){return wrapwith("html-section",html)};render.heading=function(str,level){var realLevel=level;return wrapwith("heading-section","<h"+realLevel+">"+str+"</h"+realLevel+">")};render.paragraph=function(str){return wrapwith("paragraph-section","<p>"+str+"</p>")};render.blockquote=function(str){return wrapwith("blockquote-section","<blockquote>"+str+"</blockquote>")};render.list=function(str,ordered){var wrapper=ordered?"o":"u";return wrapwith("blockquote-section","<"+wrapper+"l>"+str+"</"+wrapper+"l>")};markedOptions.renderer=render;marked.setOptions(markedOptions);function wrapwith(wrapperClass,dom){wrapperClass=typeof wrapperClass==="object"?wrapperClass.join(" "):wrapperClass;return['<section class="'+wrapperClass+'">','<div class="container">','<div class="row">','<div class="col-lg-8 col-lg-offset-2">',dom,"</div>","</div>","</div>","</section>"].join("\n")}function highlightCode(code){return hljs.highlightAuto(code).value}return $sce.trustAsHtml(marked(raw))}});airpub.controller("global",function($scope){if(!airpubConfigs)return console.error(new Error("airpub 缺少必要的配置文件!"));$scope.configs=airpubConfigs});airpub.controller("base",function($scope,$state,$timeout,$location,$duoshuo){$scope.location=$location;$scope.state=$state;$scope.alerts=[];$scope.addAlert=addAlert;$scope.closeAlert=closeAlert;$duoshuo.on("ready",function(err,data){var isVisitor=data.user_id===0;if(err||isVisitor)return;$scope.user=data});function addAlert(msg,type,dismiss){$scope.alerts.push({msg:msg,type:type||"success"});var alertIndex=$scope.alerts.length-1;$timeout(function(){$scope.closeAlert(alertIndex)},dismiss?dismiss*1e3:3e3);return alertIndex}function closeAlert(index){$scope.alerts.splice(index,1)}});airpub.controller("archive",function($scope,$state,$duoshuo){$scope.itemsPerPage=5;$scope.currentPage=1;if($scope.articles&&$scope.articles.length>0)return;fetchThreads({page:1});$scope.pageChanged=function(){console.log($scope.currentPage);fetchThreads({page:$scope.currentPage})};function fetchThreads(options){options.limit=$scope.itemsPerPage;$duoshuo.get("threads/list",options,function(err,result,res){if(err)return $scope.addAlert("获取信息失败，请重试","danger");if(result.length===0)return $state.go("404");$scope.articles=result||[];$scope.totalItems=res.cursor.total;return})}});airpub.controller("single",function($scope,$state,$duoshuo,$location){var uri=$state.params.uri;if(!uri)return $state.go("404");if($scope.article)return;$duoshuo.get("threads/details",{thread_id:uri},function(err,result){if(err)return $scope.addAlert("文章内容获取失败，请稍后再试...","danger");$scope.article=result;$duoshuo.get("users/profile",{user_id:result.author_id},function(err,result){if(err)return;$scope.author=result})});$scope.removeArticle=function(id){$duoshuo.post("threads/remove",{thread_id:id},function(err,result){if(err)return $scope.addAlert("删除失败，请稍后再试...","danger");$scope.addAlert("删除成功!");$location.path("/")})}});airpub.controller("admin",function($scope,$state,$upyun,$duoshuo,$location){$scope.isAdmin=false;var baseUri=$scope.configs.url||$location.host();$duoshuo.get("sites/membership",{},function(err,result){if(err||result.role!=="administrator")return $state.go("404");if($state.current.name==="update"&&$state.params.uri){$duoshuo.get("threads/details",{thread_id:$state.params.uri},function(err,result){$scope.isAdmin=true;if(err)return $scope.addAlert("文章内容获取失败，请稍后再试...","danger");$scope.article=result});return}$scope.isAdmin=true},function(err){$scope.addAlert(err.errorMessage,"danger")});$scope.createArticle=function(){if(!$scope.isAdmin)return false;var baby={};baby.format="markdown";baby.title=$scope.article.title;baby.content=$scope.article.content;if($scope.article.meta){angular.forEach($scope.article.meta,function(v,k){baby["meta["+k+"]"]=v})}$duoshuo.post("threads/create",baby,function(err,result){if(err)return $scope.addAlert("发布失败...","danger");$scope.addAlert("发布成功");console.log(result);return;$duoshuo.post("threads/update",{thread_id:result.thread_id,url:"/#/article/"+result.thread_id},function(err,result){$location.path("/")})})};$scope.updateArticle=function(id){if(!id)return $scope.createArticle();$duoshuo.post("threads/update",{thread_id:id,title:$scope.article.title,content:$scope.article.content},function(err,result){if(err)return $scope.addAlert("更新失败，请稍后再试...","danger");$scope.addAlert("更新成功!");console.log(result)})}});
//# sourceMappingURL=airpub.min.js.map